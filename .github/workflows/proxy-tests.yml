name: Auth Layer Proxy Tests

on:
    pull_request:
      branches: [ main, release/**]
    push:
      branches: [ main, release/*]
      tags: [ v*, v*.*.* ]

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
    proxy-tests:
        name: Proxy Tests
        runs-on: [self-hosted, Linux, medium, ephemeral]
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@63c24ba6bd7ba022e95695ff85de572c04a18142 # v2.7.0
              with:
                egress-policy: audit

            - name: Checkout repository
              uses: actions/checkout@1d96c772d19495a3b5c517cd2bc0cb401ea0529f # v4.1.3

            - name: Lua Install
              run: |
                sudo apt-get update
                sudo apt-get install -q build-essential libreadline-dev libncurses-dev lua5.3 -y
                sudo update-alternatives --install /usr/bin/lua lua-interpreter /usr/bin/lua5.3 130
                sudo update-alternatives --install /usr/bin/luac lua-compiler /usr/bin/luac5.3 130

            #############
            # Note: leado/gh-actions-lua doesn't seem to work with self-hosted runners
            # See issue #33 https://github.com/leafo/gh-actions-lua/issues/33

            #- name: Install Lua
            #  uses: leafo/gh-actions-lua@35bcb06abec04ec87df82e08caa84d545348536e # v10.0.0
            #  with:
            #    luaVersion: '5.3'
            ##############

            - name: Install LuaRocks
              uses: leafo/gh-actions-luarocks@e65774a6386cb4f24e293dca7fc4ff89165b64c5 # v4.3.0
              with:
                withLuaPath: "/usr/bin/lua"

            - name: Install lunatest
              run: luarocks install lunatest
        
            - name: Install luacov
              run: luarocks install luacov

            - name: Install luacov-console
              run: luarocks install luacov-console
        
            - name: Install cjson
              run: luarocks install lua-cjson
        
            - name: Install luasocket
              run: luarocks install luasocket
            
            - name: Run tests
              run: lua test.lua              
              working-directory: auth-layer-proxy/tests
            
            - name: Generate coverage report
              run: luacov
              working-directory: auth-layer-proxy/tests

            - name: Generate Console Report
              run: luacov-console ../filters/ && luacov-console ../filters/ -s  && luacov-console ../filters/ -s > coverage.txt
              working-directory: auth-layer-proxy/tests
